window.ThriveLeads=window.ThriveLeads||{},ThriveLeads.views=ThriveLeads.views||{},jQuery((function(){ThriveLeads.views.Assets=Backbone.View.extend({events:{"mouseenter .tve-asset-group-not-connected":"showTooltip","mouseenter .tve-available-shortcodes":"showTooltip","mouseleave .tve_tooltip_message":"hideTooltip","click .tve-available-shortcodes":"showShortcodes","click .tve-asset-group-save-connection":"saveConnection","click .tve-leads-clear-cache":"clearCacheStats","click .tl-inbound-link-builder":"inboundLinkBuilder","click .tve-asset-service, .tve-asset-group-connection-event":"addAPIConnection","click .tve-asset-group-existing-connection-event":"testAPIConnection","click .tve-asset-template, .tve-asset-group-template-event":"addWizardTemplate","click .tve-asset-download-link, .tve-asset-group-links-event":"addWizardFiles","click .tve-leads-asset-dashboard":function(){location.reload()}},viewItems:[],initialize:function(){this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.renderOne),this.listenTo(this.collection,"remove",this.removeOne)},render:function(){return this.collection.length?this.$el.find(".show-no-asset-groups").hide():this.$el.find(".show-no-asset-groups").show(),this.collection.each(this.renderOne,this),this.$el.find(".tve-setting-change").on("change",_.bind(this.globalSetting,this)),this},inboundLinkBuilder:function(){TVE_Dash.modal(ThriveLeads.views.lightbox.InboundLink,{title:ThriveLeads.const.translations.InboundLinkBuilder,"max-width":"80%",width:750,collection:ThriveLeads.objects.groups,model:new ThriveLeads.models.InboundLink})},toggleGlobalSettings:function(e){return jQuery(e.currentTarget).parents(".tve-global-settings").toggleClass("tve-expanded"),!1},globalSetting:function(e){var t=jQuery(e.currentTarget),i={action:"thrive_leads_backend_ajax",route:"globalSettingsAPI",field:t.attr("name"),value:t.attr("value"),security:ThriveLeadsConst.security};t.is('input[type="checkbox"]')&&!t.is(":checked")&&(i.value=0),this.globalSettings[i.field]=i.value,jQuery.post(ajaxurl,i)},clearCacheStats:function(){TVE_Dash.showLoader(),jQuery.post(ajaxurl,{action:"thrive_leads_backend_ajax",route:"clearCacheStatistics",security:ThriveLeadsConst.security},(function(){location.reload()}))},removeOne:function(){0===this.collection.length&&this.$el.find(".show-no-asset-groups").show()},renderOne:function(e){this.collection.length?this.$el.find(".show-no-asset-groups").hide():this.$el.find(".show-no-asset-groups").show();var t=new ThriveLeads.views.Asset({model:e}),i=t.render().$el;this.$el.find("#tve-asset-group-list").append(i);var s=e.get("ID");"undefined"!=typeof tinyMCE&&tinyMCE.init({selector:"#my-id-"+s,toolbar:"styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | ",menubar:!1,height:400,setup:function(t){t.on("init",(function(t){tinyMCE.get("my-id-"+s).setContent(e.get("post_content")),tinyMCE.execCommand("mceRepaint")}))}}),this.viewItems.push(t)},showShortcodes:function(){TVE_Dash.modal(ThriveLeads.views.lightbox.showShortcodes,{title:ThriveLeads.const.translations.showShortcodesList})},showTooltip:function(e){var t=this.$(e.target);t.wrap('<div class="tve_tooltip_wrapper">');var i=t.attr("data-title");t.before('<div class="tooltip_arrow_border">'),t.before('<div class="tooltip_arrow">'),t.before('<div class="tve_tooltip_message">'+i,"</div>")},hideTooltip:function(){var e=jQuery(this.$el).find(".tve_tooltip_wrapper");e.find(".tve_tooltip_message").remove(),e.find(".tooltip_arrow").remove(),e.find(".tooltip_arrow_border").remove(),e.contents().unwrap()},updateOrder:function(){var e={};_.each(this.viewItems,(function(t){t.model.get("order")!=t.$el.index()&&(t.model.set("order",t.$el.index()),e[t.model.get("ID")]=t.$el.index())})),this.collection.sort(),jQuery.ajax({type:"post",url:ajaxurl,data:{action:"thrive_leads_backend_ajax",route:"assets",custom:"update_order",new_order:e}})},testAPIConnection:function(){TVE_Dash.modal(ThriveLeads.views.lightbox.testAPIConnection,{title:ThriveLeads.const.translations.addAPIConnection,"max-width":"50%",model:this.model})},addAPIConnection:function(){var e=TVE_Dash.modal(ThriveLeads.views.lightbox.testAPIConnection,{title:ThriveLeads.const.translations.addAPIConnection,model:this.model,"max-width":"50%",view:"testAPIConnection"});e.gotoStep(1),e.$el.find(".tve-leads-asset-back-connection").hide()},addWizardTemplate:function(){TVE_Dash.modal(ThriveLeads.views.lightbox.emailTemplate,{title:ThriveLeads.const.translations.emailTemplate,model:this.model});try{tinymce.remove("#wp-editor")}catch(e){}var e=this.model.get("admin_name"),t=this.model.get("email_data").template_body;if(t)var i=t;else i="<p>Hello [lead_name],</p><p>Thank you for signing up!</p><p>To start the download of the [asset_name] you signed up for, just click the link below:</p><p>[asset_download]</p><p>Stay tuned for more updates coming your way soon!</p><p>Regards,<br/>"+e+"</p>";"undefined"!=typeof tinyMCE&&tinyMCE.init({selector:"#wp-editor",toolbar:"styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | ",menubar:!1,height:300,setup:function(e){e.on("init",(function(e){tinyMCE.get("wp-editor").setContent(i),tinyMCE.execCommand("mceRepaint")}))}})},addWizardFiles:function(){TVE_Dash.modal(ThriveLeads.views.lightbox.addWizardFiles,{title:ThriveLeads.const.translations.addAssetGroup,"max-width":"50%",collection:this.collection})}}),ThriveLeads.views.Asset=Backbone.View.extend({tagName:"li",className:"collapse-table-list-item",template:TVE_Dash.tpl("assets/item"),events:{"click .tve-edit-title":"showEditTitleInput","change .tve-edit-title-input input":"saveTitle","keyup .tve-edit-title-input input":"saveTitleKeyup","blur .tve-edit-title-input":"closeEditTitle","click .tve-asset-group-delete":"deleteGroupPopup","click .tve-assey-group-details":function(e){this.model.set("details_expanded",!this.model.get("details_expanded"))},"click .tve-asset-group-heading":function(e){var t=jQuery(e.target);if(t.hasClass("tve-prevent-click")||t.parents(".tve-prevent-click").length)return e.stopPropagation(),!0;this.model.set("details_expanded",!this.model.get("details_expanded"))},"click .tve-asset-group-file-add":"addFile","click .tve-asset-group-file-add-prev":"addFilePrev","click .tve-asset-change-email":"changeEmail","click .tve-asset-preview-email":"previewEmail","click .tve-asset-group-save":"addContent"},initialize:function(){this.listenTo(this.model,"change:details_expanded",this.groupDetails),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model.get("files"),"add",this.renderFile),this.listenTo(this.model.get("files"),"add",this.updateCount),this.listenTo(this.model.get("files"),"remove",this.updateCount)},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("files").length;return this.$el.find(".tve-files-count").prepend(e),this.groupDetails(),this.model.get("files").each(this.renderFile,this),this},updateCount:function(){var e=this.model.get("files").length;this.$el.find(".tve-files-count").empty(),this.$el.find(".tve-files-count").prepend(e+" Files")},addContent:function(){var e="#my-id-"+this.model.get("ID")+"_ifr",t=this.$el.find(e).contents().find("body").html(),i=this.$el.find(".tve-subject-input").val();this.model.set("post_content",t),this.model.set("post_subject",i),this.model.save({},{success:function(e,t){},complete:function(){TVE_Dash.hideLoader()}}),TVE_Dash.showLoader()},addFile:function(){var e,t=this.model.get("ID"),i=this;if(e)return e.open(),!1;(e=wp.media.frames.file_frame=wp.media({title:"Upload Asset Group Files (.zip, .pdf, .jpg, .png)",button:{text:"Use file"},frame:"post",state:"insert",multiple:!1})).on("insert",(function(){var s=e.state().get("selection").first().toJSON(),n=new ThriveLeads.models.AssetFile({name:s.name,link_anchor:s.name,link:s.url,parent_ID:t,ID:""});n.save({},{success:function(e,t){e.set("ID",t)},complete:function(){i.model.get("files").add(n)}})})),e.state("embed").on("select",(function(){var s=e.state(),n=(s.get("type"),s.props.toJSON()),o=new ThriveLeads.models.AssetFile({name:n.linkText,link_anchor:n.linkText,link:n.url,parent_ID:t,ID:""});o.save({},{success:function(e,t){e.set("ID",t)},complete:function(){i.model.get("files").add(o)}}),i.renderFiles()})),e.open()},addFilePrev:function(){TVE_Dash.modal(ThriveLeads.views.lightbox.addPrevFile,{title:ThriveLeads.const.translations.addNewFile,collection:ThriveLeads.objects.AssetsCollection,model:this.model})},previewEmail:function(){TVE_Dash.modal(ThriveLeads.views.lightbox.emailPreview,{title:ThriveLeads.const.translations.previewEmail,model:this.model})},changeEmail:function(e){TVE_Dash.modal(ThriveLeads.views.lightbox.emailChange,{title:ThriveLeads.const.translations.emailTemplate,model:this.model});var t=this.model.get("post_content"),i=jQuery(e.currentTarget).attr("data-id");try{tinymce.remove("#my-id-"+i)}catch(e){}if(t)var s=t;else s=ThriveLeads.objects.AssetsWizard.get("email_data").template_body;"undefined"!=typeof tinyMCE&&tinyMCE.init({selector:"#my-id-"+i,toolbar:"styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | ",menubar:!1,height:300,setup:function(e){e.on("init",(function(e){tinyMCE.get("my-id-"+i).setContent(s),tinyMCE.execCommand("mceRepaint")}))}})},renderFile:function(e){e.set("parent_ID",this.model.get("ID"));var t=new ThriveLeads.views.AssetFile({model:e});this.$el.find("#tve-asset-group-files").append(t.render().$el)},groupDetails:function(){this.model.get("details_expanded")?(this.$el.addClass("tve-expanded"),this.$el.find(".tve-asset-group-details").slideDown("fast")):(this.$el.removeClass("tve-expanded"),this.$el.find(".tve-asset-group-details").slideUp("fast"))},deleteGroupPopup:function(e){var t=jQuery(e.currentTarget);TVE_Dash.modal(ThriveLeads.views.lightbox.ConfirmDeleteAssetGroup,{title:t.attr("data-title"),width:650,model:ThriveLeads.objects.AssetsCollection.get(t.attr("data-id")),collection:ThriveLeads.objects.AssetsCollection})},showEditTitleInput:function(e){var t=this.$el.find(".asset-group-title").hide(),i=this.$el.find(".tve-edit-title-input");this.$el.find(".tve-files-count-holder").hide(),i.show().children("input").val(t.text().trim()).focus().select(),jQuery(e.currentTarget).hide(),e.stopPropagation()},saveTitle:function(e){var t=e.currentTarget.value;t!=this.model.get("post_title")&&(this.model.set("post_title",t),this.model.save()),this.closeEditTitle()},saveTitleKeyup:function(e){27!=e.which&&13!=e.which||this.closeEditTitle()},closeEditTitle:function(){var e=this.model.get("post_title");this.$el.find(".tve-edit-title-input input").val(e),this.$el.find(".tve-edit-title-input").hide(),this.$el.find(".asset-group-title").empty().text(e),this.$el.find(".asset-group-title,.tve-edit-title").show(),this.$el.find(".tve-files-count-holder").show()}}),ThriveLeads.views.AssetFile=Backbone.View.extend({editButtonHidden:null,tagName:"li",className:"asset-file-list-item tvd-collection-item",template:TVE_Dash.tpl("assets/file"),events:{"click .tve-edit-file-name":"showEditTitleInput","change .tve-edit-file-name-input input":"saveTitle","keyup .tve-edit-file-name-input input":"saveTitleKeyup","click .tve-asset-file-delete":"deleteAssetFile","blur .tve-edit-file-name-input":"closeEditTitle","focusout tve-edit-file-name-input":"saveTitle","hover .tvd-show-edit-title":"toggleShowEdit"},initialize:function(){this.listenTo(this.model,"change:name",this.render),this.listenTo(this.model,"change:link_anchor",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},deleteAssetFile:function(e){var t=jQuery(e.currentTarget);TVE_Dash.modal(ThriveLeads.views.lightbox.ConfirmDeleteAssetFile,{title:t.attr("data-title"),model:this.model})},showEditTitleInput:function(e){var t,i;jQuery(e.currentTarget).hasClass("tve-edit-file-name-title")?(t=this.$el.find(".asset-group-file-title").hide(),i=this.$el.find(".tve-edit-file-name-title-input"),this.$el.find(".tvd-icon-file-text2").hide()):(t=this.$el.find(".asset-group-anchor-title").hide(),i=this.$el.find(".tve-edit-file-name-anchor-input")),i.show().children("input").val(t.text().trim()).focus().select(),jQuery(e.currentTarget).hide(),this.editButtonHidden=!0,e.stopPropagation()},saveTitle:function(e){var t=jQuery(e.currentTarget);this.editButtonHidden=!1,this.model.set(t.parent().hasClass("tve-edit-file-name-title-input")?"name":"link_anchor",t.val()),this._saveModel()},_saveModel:function(){this.model.save()},saveTitleKeyup:function(e){27==e.which&&this.render()},toggleShowEdit:function(e){var t=jQuery(e.currentTarget).find(".tve-edit-file-name");1!=this.editButtonHidden&&t.fadeToggle("fast")},closeEditTitle:function(e){this.editButtonHidden=!1,this.render()}}),ThriveLeads.views.AssetFileWizard=ThriveLeads.views.AssetFile.extend({deleteAssetFile:function(e){ThriveLeads.objects.WizardAddedGroup.get("files").remove(this.model);var t=ThriveLeads.objects.WizardAddedGroup.get("files");this.model.destroy(),0==t.length&&jQuery(".asset-file-list-no-files").show()},_saveModel:function(){}}),ThriveLeads.views.AssetConnections=Backbone.View.extend({events:{"click .tve-leads-connection-setting-change":"saveConnection"},initialize:function(){this.listenTo(this.collection,"change",this.render)},render:function(){return this.$el.find("#tve-leads-test-connections").empty(),this.collection.each(this.renderOne,this),this.$el.find("#tve-leads-add-connections").empty(),ThriveLeads.objects.Apis.each(this.renderSelector,this),this},renderOne:function(e){var t=new ThriveLeads.views.AssetConnection({model:e}).render().$el;this.$el.find("#tve-leads-test-connections").append(t)},renderSelector:function(e){var t=new ThriveLeads.views.AssetSelector({model:e}).render().$el;this.$el.find("#tve-leads-add-connections").append(t)},saveConnection:function(e){var t=jQuery(e.currentTarget).attr("data"),i=this;TVE_Dash.showLoader(),jQuery.ajax({type:"post",url:ajaxurl,data:{action:"thrive_leads_backend_ajax",route:"assets",custom:"update_service",new_connection:t,security:ThriveLeadsConst.security}}).done((function(){i.collection.each((function(e,i){e.set("active",t)})),TVE_Dash.hideLoader()}))}}),ThriveLeads.views.AssetConnection=Backbone.View.extend({tagName:"li",template:TVE_Dash.tpl("assets/connections"),events:{"click .tve-asset-group-test":"testConnection"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},testConnection:function(e){var t=jQuery(e.currentTarget).attr("data"),i=this.$el.find(".tve-leads-test-connection-"+t+" .tve-asset-group-test-result"),s=this.$el.find(".tve-leads-test-response");TVE_Dash.showLoader(),jQuery.ajax({type:"post",url:ajaxurl,data:{action:"thrive_leads_backend_ajax",route:"assets",custom:"test_service",test_connection:t,security:ThriveLeadsConst.security}}).success((function(e){s.empty();var t=JSON.parse(e);t=jQuery("<textarea>").html(t).text(),t=jQuery(t),s.prepend(t),i.empty(),t.hasClass("updated")?i.append('<span class="tvd-text-green"><i class="tvd-icon-check"></i>Success</span>'):i.append('<span class="tvd-text-red"><i class="tvd-icon-remove"></i>Error</span>'),ThriveLeads.resize_thickbox(),TVE_Dash.hideLoader()}))}}),ThriveLeads.views.AssetSelector=Backbone.View.extend({template:TVE_Dash.tpl("assets/selector"),className:"tvd-col tvd-s3 tvd-center-align",render:function(){return this.$el.html(this.template({item:this.model.toJSON()})),this}})}));